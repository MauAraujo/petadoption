version: '3.9'

x-minio-common: &minio-common
  image: minio/minio:RELEASE.2021-08-20T18-32-01Z
  command: server --console-address ":9001" http://minio1/data{1...2}
  expose:
    - "9000"
    - "9001"
  environment:
    MINIO_ROOT_USER: minio
    MINIO_ROOT_PASSWORD: minio123
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
    interval: 30s
    timeout: 20s
    retries: 3

services:
    # web:
    #     build: .
    #     ports:
    #         - '3000:3000'
    #     depends_on:
    #         - server
    #         - meilisearch
    #         - nginx

    server:
        image: golang:1.17.0-alpine
        build: server
        ports:
            - '8080:8080'
        depends_on:
            - mongo
            - meilisearch
            - nginx

    mongo:
        image: mongo
        restart: always
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: admin
        ports:
            - '27017:27017'

    mongo-express:
        image: mongo-express
        restart: always
        ports:
        - '8081:8081'
        environment:
            ME_CONFIG_MONGODB_ADMINUSERNAME: root
            ME_CONFIG_MONGODB_ADMINPASSWORD: admin
            ME_CONFIG_MONGODB_URL: 'mongodb://root:admin@mongo:27017/'
        depends_on:
            - mongo

    minio1:
        <<: *minio-common
        hostname: minio1
        volumes:
            - data1-1:/data1
            - data1-2:/data2

    nginx:
        image: 'nginx:1.19.2-alpine'
        hostname: nginx
        volumes:
            - './nginx.conf:/etc/nginx/nginx.conf:ro'
        ports:
            - '9000:9000'
            - '9001:9001'
        depends_on:
            - minio1

    meilisearch:
        image: getmeili/meilisearch
        ports:
            - '7700:7700'

volumes:
    data1-1:
    data1-2: